{"transform":{"id":"300000000000019700","siteId":"272","templateId":"30","templateVersion":"1","name":"Transform Adjust Timestamp","description":"Adjust offset and Format of time (selectable by field and format)","pipelineId":"0","config":{"config_groups":[{"_name":"General Configuration","bypassed":false,"filterEnabled":false},{"_name":"Lua","enabled":true,"is_metric":false,"parallelism":1,"script":"function processEvent(event)\n    --------------------------------------------------------------------------------\n    -- 1. CONFIGURATION: Field Selection: Uncomment only ONE target_field setting\n    --------------------------------------------------------------------------------\n    local source_field = \"time\"        -- Input Field (e.g., \"_time\", \"time\", \"GenerateTime\")\n    local target_field = \"timestamp\"   -- Output Field (Creates a new timestamp field)\n    -- local target_field = source_field -- TARGET = SOURCE (This overwrites the original field)\n\n    --------------------------------------------------------------------------------\n    -- 2. TIMEZONE SELECTOR: Uncomment the ONE offset you need\n    --------------------------------------------------------------------------------\n    -- local offset_sec = 0            -- UTC (Standard for Cloud/OCSF)\n    -- local offset_sec = -12600       -- NST (Newfoundland)\n    -- local offset_sec = -14400       -- AST / EDT (Atlantic / Eastern Daylight)\n    local offset_sec = -18000          -- EST (Eastern Standard / Central Daylight)\n    -- local offset_sec = -21600       -- CST (Central Standard / Mountain Daylight)\n    -- local offset_sec = -25200       -- MST (Mountain Standard / Pacific Daylight)\n    -- local offset_sec = -28800       -- PST (Pacific Standard)\n    -- local offset_sec = -32400       -- AKST (Alaska Standard)\n    -- local offset_sec = -36000       -- HST (Hawaii-Aleutian Standard)\n\n    --------------------------------------------------------------------------------\n    -- 3. MODE SELECTOR: Output Formats : Uncomment the ONE format you need\n    --------------------------------------------------------------------------------\n    local mode = \"RFC3339\"             -- OCSF / Elastic (2026-01-12T12:28:52.651Z)\n    -- local mode = \"ISO8601_SPACE\"    -- ISO variant (2026-01-12 12:28:52.651)\n    -- local mode = \"UNIX_EPOCH\"       -- Pure Numeric (1736684932.651)\n    -- local mode = \"SPLUNK_US\"        -- Splunk Standard (01/12/2026 12:28:52.651)\n    -- local mode = \"CLF\"              -- Common Log Format (12/Jan/2026:12:28:52 -0500)\n    -- local mode = \"SYSLOG_BSD\"       -- Legacy Syslog (Jan 12 12:28:52)\n    -- local mode = \"CEF\"              -- Common Event Format (Jan 12 2026 12:28:52.651)\n    -- local mode = \"W3C_IIS\"          -- IIS/W3C (2026-01-12 12:28:52)\n    -- local mode = \"DB2\"              -- IBM DB2 (2026-01-12-12.28.52.651000)\n\n    local include_ms = true            -- Toggle sub-second precision (.000)\n\n    --------------------------------------------------------------------------------\n    -- 4. TRANSFORMATION LOGIC\n    --------------------------------------------------------------------------------\n    local function execute_transform(e)\n        local raw_val = e[source_field]\n        if not raw_val then error(\"Source field '\"..source_field..\"' is missing\") end\n\n        local epoch = 0\n        local ms_part = 0\n\n        -- A. HANDLE STRING INPUT (EntraID / ISO 8601)\n        if type(raw_val) == \"string\" then\n            -- Matches: 2026-01-12T17:28:52.651... or 2026-01-12 17:28:52\n            local y, m, d, h, min, sec, ms = raw_val:match(\"(%d+)-(%d+)-(%d+)[T ](%d+):(%d+):(%d+)%.?(%d*)\")\n            \n            if y and m and d and h and min and sec then\n                -- Convert to UTC Epoch first\n                epoch = os.time({year=y, month=m, day=d, hour=h, min=min, sec=sec})\n                \n                -- Capture Milliseconds (Truncate if >3 digits)\n                if ms and #ms > 0 then\n                    ms_part = tonumber(ms:sub(1,3))\n                end\n            else\n                -- Fallback: Try to parse as a stringified number\n                local num_try = tonumber(raw_val)\n                if num_try then\n                    epoch = num_try\n                else\n                    error(\"Could not parse date string: \" .. raw_val)\n                end\n            end\n\n        -- B. HANDLE NUMERIC INPUT (Epoch)\n        elseif type(raw_val) == \"number\" then\n            epoch = raw_val\n        else\n            error(\"Unsupported data type: \" .. type(raw_val))\n        end\n\n        -- C. NORMALIZE MAGNITUDE (Micro/Milli to Seconds)\n        if epoch > 9999999999999 then     -- Microseconds (16+ digits)\n            ms_part = math.floor((epoch / 1000) % 1000)\n            epoch = epoch / 1000000\n        elseif epoch > 9999999999 then    -- Milliseconds (13 digits)\n            ms_part = math.floor(epoch % 1000)\n            epoch = epoch / 1000\n        end\n\n        -- D. APPLY TIMEZONE OFFSET\n        local adjusted_time = math.floor(epoch + offset_sec)\n        local ms_str = string.format(\".%03d\", ms_part)\n\n        -- E. FORMAT OUTPUT\n        local final_ts = \"\"\n\n        if mode == \"RFC3339\" then\n            local base = os.date(\"!%Y-%m-%dT%H:%M:%S\", adjusted_time)\n            final_ts = base .. (include_ms and ms_str or \"\") .. \"Z\"\n\n        elseif mode == \"ISO8601_SPACE\" then\n            local base = os.date(\"%Y-%m-%d %H:%M:%S\", adjusted_time)\n            final_ts = base .. (include_ms and ms_str or \"\")\n\n        elseif mode == \"UNIX_EPOCH\" then\n            final_ts = tostring(adjusted_time) .. (include_ms and ms_str or \"\")\n\n        elseif mode == \"SPLUNK_US\" then\n            local base = os.date(\"%m/%d/%Y %H:%M:%S\", adjusted_time)\n            final_ts = base .. (include_ms and ms_str or \"\")\n\n        elseif mode == \"CLF\" then\n            -- CLF: [12/Jan/2026:12:28:52 -0500]\n            local tz_label = (offset_sec >= 0 and \"+\" or \"-\") .. string.format(\"%02d00\", math.abs(offset_sec/3600))\n            final_ts = os.date(\"%d/%b/%Y:%H:%M:%S\", adjusted_time) .. \" \" .. tz_label\n\n        elseif mode == \"SYSLOG_BSD\" then\n            final_ts = os.date(\"%b %d %H:%M:%S\", adjusted_time)\n\n        elseif mode == \"CEF\" then\n            final_ts = os.date(\"%b %d %Y %H:%M:%S\", adjusted_time) .. (include_ms and ms_str or \"\")\n\n        elseif mode == \"W3C_IIS\" then\n            final_ts = os.date(\"%Y-%m-%d %H:%M:%S\", adjusted_time)\n\n        elseif mode == \"DB2\" then\n            final_ts = os.date(\"%Y-%m-%d-%H.%M.%S\", adjusted_time) .. (include_ms and ms_str or \"000\")\n        end\n\n        e[target_field] = final_ts\n        return e\n    end\n\n    --------------------------------------------------------------------------------\n    -- 5. SAFETY WRAPPER & ERROR REPORTING\n    --------------------------------------------------------------------------------\n    local status, result = pcall(execute_transform, event)\n    if status then\n        event[\"_parsing_failed\"] = nil \n        event[\"_error_msg\"] = nil\n        return result\n    else \n        event[\"_parsing_failed\"] = \"true\" \n        event[\"_error_msg\"] = \"TS_TRANSFORM_ERR: \" .. tostring(result)\n        return event \n    end\nend"}]},"status":"NS_ACTIVE","created":"2026-01-23T17:43:51.966508Z","updated":"2026-01-23T17:43:51.966508Z","createdBy":"","updatedBy":"","isTransformGroup":false,"origin":"NODE_ORIGIN_USER","templateName":"Lua","processorType":"DATA_PROCESSOR","siteFilenames":[],"userVisible":true}}